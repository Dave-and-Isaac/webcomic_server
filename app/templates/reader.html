<!doctype html>
<html data-theme="{{ theme }}">
  <head>
    <meta charset="utf-8" />
    <title>StripStash</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/static/app.css" />
    <link rel="icon" href="/static/favicon.ico" />
  </head>
  <body>
    {% include "partials/sidebar.html" %}
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <strong><a href="/comic/{{ comic.slug }}" style="color:inherit; text-decoration:none;">{{ comic.title }}</a></strong>
          <span>
            {{ year.title }}
            {% if page_count > 0 %}
              • Page {{ page }}{% if not pdf_page_count_unknown %} / {{ page_count }}{% endif %}
            {% endif %}
          </span>
        </div>
        <a class="btn ghost" href="/comic/{{ comic.slug }}">&larr; Years</a>
      </div>
    </div>

    <div class="reader">
      <div class="reader-head">
        <div class="reader-title">
          <strong>{{ year.title }}</strong>
          <div class="muted">
            • Keyboard: <span class="kbd">←</span> <span class="kbd">→</span> <span class="kbd">Space</span>
            <span class="kbd">+</span> <span class="kbd">-</span>
            • Tip: click left/right sides to navigate
          </div>
        </div>
        <div class="reader-controls">
          {% if is_pdf %}
            <a class="btn ghost{% if view_mode == 'single' %} active{% endif %}" href="/read/{{ comic.slug }}/{{ year.slug }}/{{ page }}?view=single">Single</a>
            <a class="btn ghost{% if view_mode == 'spread' %} active{% endif %}" href="/read/{{ comic.slug }}/{{ year.slug }}/{{ page }}?view=spread">Spread</a>
          {% endif %}
          <button class="btn ghost" type="button" onclick="zoomBy(-0.1)">Zoom −</button>
          <button class="btn ghost" type="button" onclick="zoomBy(0.1)">Zoom +</button>
          <button class="btn ghost" type="button" onclick="resetZoom()">Reset</button>
          <span id="fitLabel" class="muted"></span>
        </div>
      </div>

      <div class="reader-pane">
        <div class="reader-image-wrap">
          {% if image_url %}
            <div class="image-nav">
              {% if prev_url %}
                <a class="nav-zone left" href="{{ prev_url }}" rel="prev" aria-label="Previous page"></a>
              {% endif %}
              {% if next_url %}
                <a class="nav-zone right" href="{{ next_url }}" rel="next" aria-label="Next page"></a>
              {% endif %}
              {% if second_image_url %}
                <div class="pdf-spread">
                  <img class="page-image" src="{{ image_url }}" alt="{{ page_filename if page_filename else 'Page ' ~ page }}" />
                  <img class="page-image" src="{{ second_image_url }}" alt="Page {{ second_page }}" />
                </div>
              {% else %}
                <img id="pageImage" class="page-image" src="{{ image_url }}" alt="{{ page_filename if page_filename else 'Page ' ~ page }}" />
              {% endif %}
            </div>
          {% else %}
            <div style="padding:24px;" class="muted">No images found in this year.</div>
          {% endif %}
        </div>

        <div class="reader-foot">
          <div class="reader-meta-left">
            {% if page_date %}
              <strong>Date:</strong> {{ page_date }}
            {% endif %}
          </div>
          <div class="reader-nav">
            <a class="btn{% if not first_url %} disabled{% endif %}" href="{{ first_url if first_url else '#' }}">First</a>
            {% if prev_url %}
              <a class="btn" href="{{ prev_url }}" rel="prev">Prev</a>
            {% else %}
              <span class="btn disabled">Prev</span>
            {% endif %}
            {% if next_url %}
              <a class="btn" href="{{ next_url }}" rel="next">Next</a>
            {% else %}
              <span class="btn disabled">Next</span>
            {% endif %}
            <a class="btn{% if not last_url %} disabled{% endif %}" href="{{ last_url if last_url else '#' }}">Last</a>
          </div>
          <div class="reader-meta-right">
            {% if page_title %}
              <strong>Title:</strong> {{ page_title }}
            {% elif page_filename %}
              <strong>File:</strong> {{ page_filename }}
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <script>
      const keyboardEnabled = {{ 'true' if keyboard_enabled else 'false' }};
      const zoomKey = "readerZoom";

      function updateFitLabel(mode) {
        const label = document.getElementById('fitLabel');
        if (!label) return;
        const zoomPct = Math.round(getZoom() * 100);
        label.textContent = 'Zoom ' + zoomPct + '%';
      }

      updateFitLabel('zoom');

      function getZoom() {
        const z = parseFloat(localStorage.getItem(zoomKey) || "1");
        return isNaN(z) ? 1 : z;
      }

      function setZoom(z) {
        const clamped = Math.max(0.1, Math.min(3, z));
        localStorage.setItem(zoomKey, clamped.toString());
        updateFitLabel('zoom');
        applySizing();
      }

      function zoomBy(delta) {
        setZoom(getZoom() + delta);
      }

      function resetZoom() {
        setZoom(1);
      }

      function applySizing() {
        const imgs = document.querySelectorAll('.page-image');
        if (!imgs.length) return;
        const zoom = getZoom();
        imgs.forEach((img) => {
          if (!img.complete || !img.naturalWidth) return;
          img.style.width = '';
          img.style.height = '';
          img.style.transformOrigin = '50% 0%';
          img.style.transform = '';
          img.style.width = (img.naturalWidth * zoom) + 'px';
          img.style.height = (img.naturalHeight * zoom) + 'px';
        });

        const wrap = document.querySelector('.reader-image-wrap');
        const pane = document.querySelector('.reader-pane');
        const foot = document.querySelector('.reader-foot');
        if (wrap && pane) {
          const gap = parseFloat(getComputedStyle(document.querySelector('.pdf-spread') || wrap).columnGap || 0);
          let totalWidth = 0;
          let maxHeight = 0;
          imgs.forEach((img, idx) => {
            if (!img.complete || !img.naturalWidth) return;
            totalWidth += img.naturalWidth * zoom;
            if (idx > 0) totalWidth += gap;
            maxHeight = Math.max(maxHeight, img.naturalHeight * zoom);
          });
          if (totalWidth > 0) {
            pane.style.width = totalWidth + 'px';
            wrap.style.width = totalWidth + 'px';
            wrap.style.height = maxHeight + 'px';
            if (foot) foot.style.width = totalWidth + 'px';
            const appContent = document.querySelector('.app-content');
            if (appContent) {
              requestAnimationFrame(() => {
                appContent.scrollLeft = Math.max(0, (pane.offsetWidth - appContent.clientWidth) / 2);
              });
            }
          }
        }
      }

      setZoom(getZoom());
      window.addEventListener('resize', applySizing);
      const imgEls = document.querySelectorAll('.page-image');
      imgEls.forEach((imgEl) => imgEl.addEventListener('load', applySizing));
      applySizing();

      // Keyboard nav: left/right + space for next
      document.addEventListener("keydown", (e) => {
        if (!keyboardEnabled) return;
        if (e.metaKey || e.ctrlKey || e.altKey) return;
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
        if (tag === "input" || tag === "textarea") return;

        const prevUrl = "{{ prev_url or '' }}";
        const nextUrl = "{{ next_url or '' }}";

        const zoomInKey = e.key === "+" || e.key === "=" || e.code === "NumpadAdd";
        const zoomOutKey = e.key === "-" || e.key === "_" || e.code === "NumpadSubtract";
        if (zoomInKey) {
          e.preventDefault();
          zoomBy(0.1);
          return;
        }
        if (zoomOutKey) {
          e.preventDefault();
          zoomBy(-0.1);
          return;
        }

        if (e.key === "ArrowLeft" && prevUrl) window.location.href = prevUrl;
        if (e.key === "ArrowRight" && nextUrl) window.location.href = nextUrl;
        if (e.key === " " && nextUrl) { e.preventDefault(); window.location.href = nextUrl; }
      });
    </script>
    {% include "partials/footer.html" %}
    {% include "partials/change_password_modal.html" %}
  </div>
  </div>
  </body>
</html>
