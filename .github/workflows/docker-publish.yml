name: Publish Docker image

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag to publish (defaults to VERSION file)"
        required: false
        type: string
      publish_latest:
        description: "Also publish the :latest tag"
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Read version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            echo "version=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            echo "version=$(cat VERSION)" >> "$GITHUB_OUTPUT"
          fi

      - name: Normalize owner
        id: owner
        run: echo "owner=${GITHUB_REPOSITORY_OWNER,,}" >> "$GITHUB_OUTPUT"

      - name: Build tag list
        id: meta
        run: |
          TAGS="ghcr.io/${{ steps.owner.outputs.owner }}/webcomic-reader:${{ steps.version.outputs.version }}"
          if [ "${{ inputs.publish_latest }}" = "true" ]; then
            TAGS="${TAGS}\nghcr.io/${{ steps.owner.outputs.owner }}/webcomic-reader:latest"
          fi
          echo "tags<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$TAGS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.version=${{ steps.version.outputs.version }}

      - name: Publish summary
        run: |
          {
            echo "## Docker image published"
            echo ""
            echo "**Image:** \`ghcr.io/${{ steps.owner.outputs.owner }}/webcomic-reader\`"
            echo ""
            echo "**Version:** \`${{ steps.version.outputs.version }}\`"
            echo ""
            echo "**Platforms:** \`linux/amd64, linux/arm64\`"
            echo ""
            echo "**Tags:**"
            echo '```'
            echo "${{ steps.meta.outputs.tags }}"
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"
